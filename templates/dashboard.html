<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ID Card Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1>Admin Dashboard</h1>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/admin/logout">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="admin-tabs">
            <button class="tab-btn active" onclick="switchTab('cards')">Cards</button>
            <button class="tab-btn" onclick="switchTab('watermark')">Watermark</button>
            <button class="tab-btn" onclick="switchTab('templates')">Templates</button>
            <button class="tab-btn" onclick="switchTab('logs')">Audit Log</button>
        </div>

        <!-- Cards Tab -->
        <div id="cards" class="tab-content active">
            <h2>Generated ID Cards</h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>ID Number</th>
                        <th>Name</th>
                        <th>Organization</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for card in cards.items %}
                    <tr>
                        <td>{{ card.id_number }}</td>
                        <td>{{ card.full_name }}</td>
                        <td>{{ card.organization }}</td>
                        <td>
                            <span class="badge badge-{{ card.status.lower() }}">{{ card.status }}</span>
                        </td>
                        <td>{{ card.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <button class="btn-sm btn-info" onclick="viewCard({{ card.id }})">View</button>
                            {% if card.status == 'VALID' %}
                            <button class="btn-sm btn-danger" onclick="revokeCard({{ card.id }})">Revoke</button>
                            {% else %}
                            <button class="btn-sm btn-success" onclick="enableCard({{ card.id }})">Enable</button>
                            {% endif %}
                            <a href="/admin/card/{{ card.id }}/download/png" class="btn-sm btn-primary">PNG</a>
                            <a href="/admin/card/{{ card.id }}/download/pdf" class="btn-sm btn-primary">PDF</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% if cards.pages > 1 %}
            <div class="pagination">
                {% if cards.has_prev %}<a href="?page={{ cards.prev_num }}">Prev</a>{% endif %}
                {% for page_num in cards.iter_pages() %}
                    {% if page_num %}
                        <a href="?page={{ page_num }}" class="{% if page_num == cards.page %}active{% endif %}">{{ page_num }}</a>
                    {% endif %}
                {% endfor %}
                {% if cards.has_next %}<a href="?page={{ cards.next_num }}">Next</a>{% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Watermark Tab -->
        <div id="watermark" class="tab-content">
            <h2>Watermark Settings</h2>
            <form id="watermarkForm">
                <div class="form-group">
                    <label><input type="checkbox" id="wmEnabled" name="enabled" {% if watermark and watermark.enabled %}checked{% endif %}> Enable Watermark</label>
                </div>
                <div class="form-group">
                    <label>Text</label>
                    <input type="text" id="wmText" name="text" value="{{ watermark.text if watermark else 'STAFF' }}">
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <input type="color" id="wmColor" name="color" value="{{ watermark.color if watermark else '#888888' }}">
                </div>
                <div class="form-group">
                    <label>Opacity (0-255)</label>
                    <input type="number" id="wmOpacity" name="opacity" min="0" max="255" value="{{ watermark.opacity if watermark else 128 }}">
                </div>
                <div class="form-group">
                    <label>Position</label>
                    <select id="wmPosition" name="position">
                        <option value="top" {% if watermark and watermark.position == 'top' %}selected{% endif %}>Top</option>
                        <option value="center" {% if watermark and watermark.position == 'center' %}selected{% endif %}>Center</option>
                        <option value="bottom" {% if watermark and watermark.position == 'bottom' %}selected{% endif %}>Bottom</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Update Watermark</button>
            </form>
        </div>

        <!-- Templates Tab -->
        <div id="templates" class="tab-content">
            <h2>Card Templates</h2>
            <button onclick="openAddTemplateModal()" class="btn btn-primary">Add Template</button>
            <div id="templatesList" style="margin-top: 20px;">
                {% for template in templates %}
                <div class="template-card">
                    <h3>{{ template.name }}</h3>
                    <button class="btn-sm btn-primary" onclick="openEditTemplateModal({{ template.id }}, '{{ template.name }}')">Edit</button>
                    {% if not template.is_active %}<span class="badge">Inactive</span>{% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="logs" class="tab-content">
            <h2>Audit Log</h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Admin</th>
                        <th>Action</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td>{{ log.admin_user }}</td>
                        <td>{{ log.action }}</td>
                        <td>{{ log.details }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Card View Modal -->
    <div id="cardModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeCardModal()">&times;</span>
            <h2>ID Card Preview</h2>
            <div id="cardModalBody"></div>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeTemplateModal()">&times;</span>
            <h2 id="templateModalTitle">Add Template</h2>
            <form id="templateForm">
                <input type="hidden" id="templateId" name="template_id">
                
                <div class="form-group">
                    <label>Template Name*</label>
                    <input type="text" id="templateName" name="name" required>
                </div>

                <div class="form-group">
                    <label>Card Width (pixels)</label>
                    <input type="number" id="cardWidth" name="width" value="1000" min="500">
                </div>

                <div class="form-group">
                    <label>Card Height (pixels)</label>
                    <input type="number" id="cardHeight" name="height" value="600" min="300">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Header Height</label>
                        <input type="number" id="headerHeight" name="header_height" value="120" min="50">
                    </div>
                    <div class="form-group">
                        <label>Header Color</label>
                        <input type="color" id="headerColor" name="header_color" value="#003366">
                    </div>
                </div>

                <div class="form-group">
                    <label>Background Color</label>
                    <input type="color" id="bgColor" name="background_color" value="#ffffff">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Photo X Position</label>
                        <input type="number" id="photoX" name="photo_x" value="30" min="0">
                    </div>
                    <div class="form-group">
                        <label>Photo Y Position</label>
                        <input type="number" id="photoY" name="photo_y" value="160" min="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Text X Position</label>
                        <input type="number" id="textX" name="text_x" value="230" min="0">
                    </div>
                    <div class="form-group">
                        <label>Text Y Position</label>
                        <input type="number" id="textY" name="text_y" value="160" min="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>QR X Position</label>
                        <input type="number" id="qrX" name="qr_x" value="800" min="0">
                    </div>
                    <div class="form-group">
                        <label>QR Y Position</label>
                        <input type="number" id="qrY" name="qr_y" value="400" min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label>QR Size</label>
                    <input type="number" id="qrSize" name="qr_size" value="120" min="50">
                </div>

                <div class="form-group">
                    <label><input type="checkbox" id="templateActive" name="is_active" checked> Active</label>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">Save Template</button>
                    <button type="button" class="btn" onclick="closeTemplateModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function revokeCard(cardId) {
            if (!confirm('Revoke this card?')) return;
            fetch(`/admin/card/${cardId}/revoke`, { method: 'POST' })
                .then(r => r.json())
                .then(d => {
                    if (d.success) location.reload();
                    else alert(d.error);
                });
        }

        function enableCard(cardId) {
            if (!confirm('Enable this card?')) return;
            fetch(`/admin/card/${cardId}/enable`, { method: 'POST' })
                .then(r => r.json())
                .then(d => {
                    if (d.success) location.reload();
                    else alert(d.error);
                });
        }

        document.getElementById('watermarkForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                text: document.getElementById('wmText').value,
                color: document.getElementById('wmColor').value,
                opacity: parseInt(document.getElementById('wmOpacity').value),
                position: document.getElementById('wmPosition').value,
                enabled: document.getElementById('wmEnabled').checked
            };
            const response = await fetch('/admin/watermark', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.success) alert('Watermark updated!');
        });

        function viewCard(cardId) {
            fetch(`/admin/card/${cardId}/view`)
                .then(r => r.json())
                .then(data => {
                    const html = `
                        <div class="card-detail-view">
                            <table class="detail-table">
                                <tr><td><strong>ID Number:</strong></td><td>${data.id_number}</td></tr>
                                <tr><td><strong>Name:</strong></td><td>${data.full_name}</td></tr>
                                <tr><td><strong>Organization:</strong></td><td>${data.organization}</td></tr>
                                <tr><td><strong>DOB:</strong></td><td>${data.date_of_birth}</td></tr>
                                <tr><td><strong>Address:</strong></td><td>${data.address}</td></tr>
                                <tr><td><strong>Issue Date:</strong></td><td>${data.issue_date}</td></tr>
                                <tr><td><strong>Expiry Date:</strong></td><td>${data.expiry_date}</td></tr>
                                <tr><td><strong>Status:</strong></td><td><span class="badge badge-${data.status.toLowerCase()}">${data.status}</span></td></tr>
                            </table>
                            <div style="margin-top: 20px; text-align: center;">
                                <img src="/static/cards/${data.card_png}?t=${Date.now()}" style="max-width: 100%; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                    `;
                    document.getElementById('cardModalBody').innerHTML = html;
                    document.getElementById('cardModal').style.display = 'block';
                });
        }

        function closeCardModal() {
            document.getElementById('cardModal').style.display = 'none';
        }

        function openAddTemplateModal() {
            document.getElementById('templateId').value = '';
            document.getElementById('templateName').value = '';
            document.getElementById('templateModalTitle').textContent = 'Add New Template';
            document.getElementById('templateForm').reset();
            document.getElementById('templateModal').style.display = 'block';
        }

        function openEditTemplateModal(templateId, templateName) {
            fetch(`/admin/template/${templateId}`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('templateId').value = templateId;
                    document.getElementById('templateName').value = data.name;
                    document.getElementById('cardWidth').value = data.config.width || 1000;
                    document.getElementById('cardHeight').value = data.config.height || 600;
                    document.getElementById('headerHeight').value = data.config.header_height || 120;
                    document.getElementById('headerColor').value = data.config.header_color || '#003366';
                    document.getElementById('bgColor').value = data.config.background_color || '#ffffff';
                    document.getElementById('photoX').value = data.config.photo_x || 30;
                    document.getElementById('photoY').value = data.config.photo_y || 160;
                    document.getElementById('textX').value = data.config.text_x || 230;
                    document.getElementById('textY').value = data.config.text_y || 160;
                    document.getElementById('qrX').value = data.config.qr_x || 800;
                    document.getElementById('qrY').value = data.config.qr_y || 400;
                    document.getElementById('qrSize').value = data.config.qr_size || 120;
                    document.getElementById('templateActive').checked = data.is_active;
                    
                    document.getElementById('templateModalTitle').textContent = 'Edit Template';
                    document.getElementById('templateModal').style.display = 'block';
                });
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').style.display = 'none';
        }

        document.getElementById('templateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const config = {
                width: parseInt(document.getElementById('cardWidth').value),
                height: parseInt(document.getElementById('cardHeight').value),
                header_height: parseInt(document.getElementById('headerHeight').value),
                header_color: document.getElementById('headerColor').value,
                background_color: document.getElementById('bgColor').value,
                photo_x: parseInt(document.getElementById('photoX').value),
                photo_y: parseInt(document.getElementById('photoY').value),
                text_x: parseInt(document.getElementById('textX').value),
                text_y: parseInt(document.getElementById('textY').value),
                qr_x: parseInt(document.getElementById('qrX').value),
                qr_y: parseInt(document.getElementById('qrY').value),
                qr_size: parseInt(document.getElementById('qrSize').value)
            };

            const data = {
                id: document.getElementById('templateId').value || null,
                name: document.getElementById('templateName').value,
                config: config,
                is_active: document.getElementById('templateActive').checked
            };

            const response = await fetch('/admin/template', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (result.success) {
                alert('Template saved!');
                closeTemplateModal();
                location.reload();
            } else {
                alert('Error: ' + (result.error || 'Failed to save template'));
            }
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const cardModal = document.getElementById('cardModal');
            const templateModal = document.getElementById('templateModal');
            if (event.target === cardModal) cardModal.style.display = 'none';
            if (event.target === templateModal) templateModal.style.display = 'none';
        }
    </script>
</body>
</html>
